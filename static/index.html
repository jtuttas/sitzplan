<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sitzplatzzuordnung an der MMBbS">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sitzplatzzuordnung MMBbS Hannover</title>
    <!-- Favicons-->
    <link rel="apple-touch-icon" sizes="57x57" href="img/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="img/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="img/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="img/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="img/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="img/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-icon-180x180.png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="192x192" href="img/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="img/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="img/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <!-- jQuery, Bootstrap und CSS einbinden-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
</head>
<body class="text-center">
    <div class="form-signin bg-white rounded">
        <header>
            <img class="mb-4 mt-2" src="img/mmbbs-logo.svg" height="80"
                onerror="this.onerror=null; this.src='mmbbs-logo.svg'">
            <h1 class="h3">Sitzplatz zuordnen</h1>
        </header>
        <section id="formArea">
            <p><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-upc-scan" fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1h-3zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5zM.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5z" />
                    <path
                        d="M3 4.5a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm2 0a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm2 0a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm2 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-7zm3 0a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7z" />
                </svg> Raum <span id="room">?</span>
            </p>
            <article>
                <form id="input-form" class="form-signin">
                    <label for="inputName" class="sr-only">Name</label>
                    <input type="name" id="inputName" class="form-control" placeholder="Vorname Nachname" aria-describedby="inputNameFeedback" required
                        autofocus>
                        <div id="inputNameFeedback" class="invalid-feedback mb-2">
                            Bitte Vor- und Nachname eingeben!
                        </div>
                    <div class="checkbox mt-2 mb-2">
                        <label>
                            <input id="c1" type="checkbox" value="true"> Name merken
                        </label>
                    </div>
                    <button id="s1" class="btn btn-block btn-lg btn-primary">Absenden</button>        
                </form>
            </article>
            <div id="successSign" class="d-flex justify-content-center"></div>
        </section>
        <div id="Msg" class="d-flex justify-content-center"></div>
        <footer>
            <p class="mt-3 text-muted">&copy; 2020 MMBbS Hannover</p>
        </footer>
    </div>
</body>

<script> 
    
    let url_string = window.location.href;
    let url = new URL(url_string);
    let id = url.searchParams.get("id");
    let room = url.searchParams.get("room");
    if (id == undefined || id == "" || room == undefined || room == "") {
        $("#formArea").addClass("hidden");
        $("#Msg").show().text("Missing Parameter").addClass("error");
    }
    else {
        console.log('ID=' + id);
        $("#room").text(room);

        /* Cookie auslesen */
        $("#inputName").val(Cookies.get('name'));
        if($("#inputName").val() == "") {
            $("#s1").prop("disabled", true);
        }

        /* Hinweis bei ausbleibender Eingabe */
        $("#inputName").bind("focusout keyup", function() {
            if($("#inputName").val() == "") {
                $(this).addClass("is-invalid").focus();
                $("#inputNameFeedback").show();
                $("#s1").prop("disabled", true);
            } else {
                $(this).removeClass("is-invalid");
                $("#inputNameFeedback").fadeOut("fast");
                $("#s1").prop("disabled", false);
            }
        });

        /* Button best√§tigt */
        $("#s1").click(function (e) {
            event.preventDefault();
            if($("#inputName").val() != "") {        
                $("#c1").prop("disabled", true);

                /* Cookie schreiben */
                if($("#c1").is(":checked")) {
                    Cookies.set('name',$("#inputName").val(), { expires: 14 });
                }
                
                $("#s1").html('<span class="spinner-border spinner-border" role="status" aria-hidden="true"></span>');
                obj = {
                    name: $("#inputName").val(),
                    id: id
                }
                console.log('post:' + JSON.stringify(obj));
                $.ajax({
                    url: '/api/v1/',
                    type: 'post',
                    data: JSON.stringify(obj),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        console.log('data=' + JSON.stringify(data));
                        if (data.success == true) {
                            $("#formArea article").fadeOut("slow", function () {
                                $("#successSign").html('<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" /><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" /></svg>').addClass("success");
                            });
                            $("#Msg").text(data.msg).addClass("success");
                        } else {
                            $("#s1").prop("disabled", false);
                            $("#inputName").prop("disabled", false);
                            $("#c1").prop("disabled", false);
                            $("#s1").text("Absenden");
                            $("#Msg").text(data.msg).addClass("error");
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        $("#s1").prop("disabled", false);
                        $("#inputName").prop("disabled", false);
                        $("#c1").prop("disabled", false);
                        $("#s1").text("Absenden");
                        $("#Msg").show().text("Eintrag leider fehlgeschlagen").addClass('error');
                        console.log(xhr.status);
                        console.log(thrownError);
                    }
                });
            } else {
                $("#inputName").addClass("is-invalid").focus();
                $("#inputNameFeedback").show();

            } 
        });
    }
</script>

</body>

</html>